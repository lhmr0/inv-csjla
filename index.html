<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - CSJLA</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1F2937">
    <meta name="description" content="Sistema moderno de inventario con escÃ¡ner de cÃ³digos de barras en tiempo real">
    <link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>Inventario</h1>
                    <p class="header-subtitle">CSJLA</p>
                </div>
                <div class="user-info" id="userInfo">
                    <span id="userName">No conectado</span>
                </div>
            </div>
        </header>

        <!-- Pantalla de Login -->
        <section id="loginSection" class="section">
            <div class="card">
                <h2>ğŸ” Iniciar SesiÃ³n</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.95rem;">Ingrese su nombre para comenzar a inventariar</p>
                <div class="form-group">
                    <label for="operatorName">Nombre del Operador:</label>
                    <input type="text" id="operatorName" placeholder="Ej: Juan PÃ©rez" required autofocus>
                </div>
                <button id="btnConnect" class="btn btn-primary btn-block" style="width: 100%;">Conectar</button>
            </div>
        </section>

        <!-- Pantalla Principal -->
        <section id="mainSection" class="section hidden">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="scanner">ğŸ“· Escanear</button>
                <button class="tab" data-tab="manual">âœï¸ Manual</button>
                <button class="tab" data-tab="history">ğŸ“‹ Historial</button>
                <button class="tab" data-tab="stats">ğŸ“Š EstadÃ­sticas</button>
                <button class="tab" data-tab="inventoried">âœ… Inventariados</button>
            </div>

            <!-- Tab: Scanner -->
            <div id="scannerTab" class="tab-content active">
                <div class="card">
                    <h3>Escanear CÃ³digo de Barras</h3>
                    <div id="scannerContainer" style="position: relative; width: 100%; display: inline-block;">
                        <div id="video" style="width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #000;"></div>
                        <!-- Canvas overlay para delimitar Ã¡rea de escaneo -->
                        <canvas id="scannerOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; cursor: crosshair; z-index: 10;"></canvas>
                    </div>
                    <div class="scanner-controls">
                        <button id="btnStartScan" class="btn btn-success">â–¶ï¸ Iniciar CÃ¡mara</button>
                        <button id="btnStopScan" class="btn btn-danger hidden">â¹ï¸ Detener CÃ¡mara</button>
                        <button id="btnSwitchCamera" class="btn btn-secondary hidden">ğŸ”„ Cambiar CÃ¡mara</button>
                        <button id="btnCaptureFrame" class="btn btn-primary hidden">ğŸ“¸ Capturar Frame</button>
                    </div>
                    <div id="capturedFrames" class="form-group" style="margin-top: 1rem; display: none;">
                        <label>ğŸ“· Frames Capturados:</label>
                        <div id="framesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="imageInput">O cargar una imagen:</label>
                        <input type="file" id="imageInput" accept="image/*" />
                        <button id="btnProcessImage" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">ğŸ“¸ Procesar Imagen</button>
                    </div>
                    <div id="manualFallback" class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <label for="manualImageCode">Si la detecciÃ³n automÃ¡tica falla, ingrese el cÃ³digo manualmente:</label>
                        <input type="text" id="manualImageCode" placeholder="Ingrese el cÃ³digo que ve en la imagen" />
                        <button id="btnUseManualCode" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">âœ… Usar este cÃ³digo</button>
                    </div>
                    <div id="manualCodeMFallback" class="form-group" style="margin-top: 0.75rem;">
                        <label for="manualCodeM">O buscar por CÃ³digo M (columna I):</label>
                        <input type="text" id="manualCodeM" placeholder="Ingrese CÃ³digo M" />
                        <button id="btnUseManualCodeM" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">ğŸ” Buscar CÃ³digo M</button>
                    </div>
                    <div id="lastScanned" class="last-scanned hidden">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap;">
                            <strong>Ãšltimo cÃ³digo escaneado:</strong>
                            <span id="lastCode" style="display: flex; align-items: center; gap: 0.5rem;"></span>
                            <button id="btnSearchLastCode" class="btn btn-primary btn-small" style="display: none; margin-left: 0.5rem;">
                                ğŸ” Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Manual -->
            <div id="manualTab" class="tab-content hidden">
                <div class="card">
                    <h3>Ingreso Manual de CÃ³digo</h3>
                    <div class="form-group">
                        <label for="manualCode">CÃ³digo de Barras:</label>
                        <input type="text" id="manualCode" placeholder="Ingrese el cÃ³digo manualmente">
                    </div>
                    <button id="btnManualSearch" class="btn btn-primary">ğŸ” Buscar</button>
                </div>
            </div>

            <!-- Tab: History -->
            <div id="historyTab" class="tab-content hidden">
                <div class="card">
                    <h3>Historial de Escaneos</h3>
                    <div class="history-controls">
                        <button id="btnClearHistory" class="btn btn-danger btn-small">ğŸ—‘ï¸ Limpiar</button>
                        <button id="btnExportHistory" class="btn btn-secondary btn-small">ğŸ“¥ Exportar</button>
                    </div>
                    <div id="historyList" class="history-list">
                        <p class="empty-message">No hay escaneos realizados</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Stats -->
            <div id="statsTab" class="tab-content hidden">
                <div class="card">
                    <h3>EstadÃ­sticas de Inventario</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="statTotal">0</span>
                            <span class="stat-label">Total Items</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="statInventoried">0</span>
                            <span class="stat-label">Inventariados</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="statPending">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="statToday">0</span>
                            <span class="stat-label">Hoy</span>
                        </div>
                    </div>
                    <button id="btnRefreshStats" class="btn btn-primary">ğŸ”„ Actualizar EstadÃ­sticas</button>
                </div>
            </div>

            <!-- Tab: Inventoried Items -->
            <div id="inventoriedTab" class="tab-content hidden">
                <div class="card">
                    <h3>Bienes Inventariados</h3>
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button id="btnRefreshInventoried" class="btn btn-secondary btn-small">ğŸ”„ Actualizar</button>
                        <button id="btnGenerateReport" class="btn btn-success btn-small">ğŸ“„ Generar Documento Word</button>
                        <button id="btnExportInventorieds" class="btn btn-secondary btn-small">ğŸ“Š Exportar CSV</button>
                    </div>
                    <div id="inventoriedList" class="inventoried-list">
                        <p class="empty-message">No hay bienes inventariados</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal de Resultado -->
        <div id="resultModal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div id="modalBody">
                    <!-- Contenido dinÃ¡mico -->
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="toast-container"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p>Procesando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <!-- Load docx with proper UMD -->
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Ensure docx is available globally -->
    <script>
        window.docxReady = new Promise((resolve) => {
            if (window.docx) {
                resolve(window.docx);
            } else {
                const checkDocx = setInterval(() => {
                    if (window.docx) {
                        clearInterval(checkDocx);
                        resolve(window.docx);
                    }
                }, 100);
                setTimeout(() => clearInterval(checkDocx), 5000);
            }
        });
    </script>
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/sheets.js"></script>
    <script src="js/drive-integration.js"></script>
    <script src="js/scanner-ocr.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
