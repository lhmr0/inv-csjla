# ğŸ“Š Diagrama - SoluciÃ³n CORS v2.1

## ğŸ”„ Flujo Completo de ConexiÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Usuario Click en "Conectar"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ App.connect(data) iniciado â”‚
        â”‚ SheetsAPI.init()           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  SheetsAPI.fetchData() intenta GET    â”‚
        â”‚  Endpoint 1: /export?format=csv&gid=0 â”‚
        â”‚  (Menos restrictivo con CORS)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ… OK      â”‚ âŒ Error/CORS
                     â”‚            â”‚
                â”Œâ”€â”€â”€â”€â–¼â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚Parseaâ”‚      â”‚  Intenta Endpoint 2:          â”‚
                â”‚CSV  â”‚      â”‚  /gviz/tq?tqx=out:csv&sheet=X â”‚
                â”‚     â”‚      â”‚  (API de Visualization)       â”‚
                â””â”€â”€â”€â”€â”¬â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚ âœ… OK   â”‚ âŒ Error/CORS
                     â”‚       â”Œâ”€â”€â”€â”€â–¼â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚       â”‚Parsea   â”‚ Â¿Hay cachÃ©?       â”‚
                     â”‚       â”‚CSV â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                     â”‚       â””â”€â”€â”€â”€â”¤        â”‚ âœ… SÃ  â”‚ âŒ NO
                     â”‚            â”‚   â”Œâ”€â”€â”€â”€â–¼â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚            â”‚   â”‚Usa  â”‚   â”‚ âŒ ERROR:   â”‚
                     â”‚            â”‚   â”‚cachÃ©â”‚   â”‚ No se pudo  â”‚
                     â”‚            â”‚   â”‚data â”‚   â”‚ conectar    â”‚
                     â”‚            â”‚   â””â”€â”€â”€â”€â”¤   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚        â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚        â”‚                â”‚
                                  â–¼        â–¼                â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Storage.setCachedData()â”‚
                          â”‚ Cachea datos nuevos    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ App.connect() completa â”‚
                          â”‚ Guarda sesiÃ³n:         â”‚
                          â”‚ - operator             â”‚
                          â”‚ - sheetUrl             â”‚
                          â”‚ - sheetName            â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ UI.showMain()          â”‚
                          â”‚ Pantalla principal     â”‚
                          â”‚ [Escanear|Manual|...]  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ âœ… LOGIN EXITOSO      â”‚
                          â”‚ App funciona           â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ­ Casos de Uso EspecÃ­ficos

### Caso 1: Primera Vez, Con Internet âœ…

```
Conectar
   â†“
Endpoint /export
   â”œâ”€ âœ… Funciona
   â””â”€ Cachea datos
   
Resultado: âœ… Login exitoso
CachÃ©: âœ… Disponible para prÃ³ximas veces
```

---

### Caso 2: Primera Vez, CORS Bloqueado + CachÃ© Antiguo âœ…

```
Conectar
   â†“
Endpoint /export
   â”œâ”€ âŒ CORS error
   â””â”€ Endpoint /gviz
       â”œâ”€ âŒ CORS error
       â””â”€ Â¿CachÃ© antiguo?
           â”œâ”€ âœ… SÃ â†’ Usa cachÃ©
           â””â”€ âœ… Actualiza si es posible
   
Resultado: âœ… Login exitoso (modo offline)
```

---

### Caso 3: Sin Internet + CachÃ© Disponible âœ…

```
Conectar
   â†“
Endpoint /export
   â”œâ”€ âŒ Sin internet (error de red)
   â””â”€ Intenta Endpoint /gviz
       â”œâ”€ âŒ Sin internet (error de red)
       â””â”€ Â¿CachÃ© disponible?
           â”œâ”€ âœ… SÃ â†’ Usa cachÃ©
           
Resultado: âœ… Login exitoso (modo offline)
```

---

### Caso 4: Primera Vez, Sin Internet, Sin CachÃ© âŒ

```
Conectar
   â†“
Endpoint /export
   â”œâ”€ âŒ Sin internet
   â””â”€ Endpoint /gviz
       â”œâ”€ âŒ Sin internet
       â””â”€ Â¿CachÃ© disponible?
           â””â”€ âŒ NO
           
Resultado: âŒ ERROR
SoluciÃ³n: Conecta a internet e intenta de nuevo
```

---

## ğŸ“¡ ComparaciÃ³n de Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENDPOINT 1: /export?format=csv&gid=0 (NUEVO)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URL: https://docs.google.com/spreadsheets/d/[ID]/       â”‚
â”‚      export?format=csv&gid=0                            â”‚
â”‚                                                         â”‚
â”‚ Ventajas:                                               â”‚
â”‚ âœ… Menos restrictivo con CORS (endpoint de descarga)    â”‚
â”‚ âœ… Directo a formato CSV                                â”‚
â”‚ âœ… Generalmente funciona primer                         â”‚
â”‚                                                         â”‚
â”‚ Desventajas:                                            â”‚
â”‚ âŒ A veces Google lo bloquea                            â”‚
â”‚ âŒ Requiere ID de la hoja (gid=0 por defecto)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENDPOINT 2: /gviz/tq?tqx=out:csv&sheet=X (ALTERNATIVA)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URL: https://docs.google.com/spreadsheets/d/[ID]/      â”‚
â”‚      gviz/tq?tqx=out:csv&sheet=NombreHoja              â”‚
â”‚                                                         â”‚
â”‚ Ventajas:                                               â”‚
â”‚ âœ… API de Google Visualization (mÃ¡s robusta)           â”‚
â”‚ âœ… Usa nombre de la hoja (mÃ¡s flexible)                â”‚
â”‚ âœ… Funciona cuando /export falla                       â”‚
â”‚                                                         â”‚
â”‚ Desventajas:                                            â”‚
â”‚ âŒ Puede ser mÃ¡s lento                                 â”‚
â”‚ âŒ Google a veces lo bloquea tambiÃ©n                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FALLBACK: CachÃ© Local (localStorage) âœ…                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UbicaciÃ³n: localStorage["cachedData"]                   â”‚
â”‚                                                         â”‚
â”‚ Ventajas:                                               â”‚
â”‚ âœ… SIEMPRE funciona (es local)                         â”‚
â”‚ âœ… Offline 100%                                        â”‚
â”‚ âœ… Inmediato (no requiere red)                         â”‚
â”‚                                                         â”‚
â”‚ Desventajas:                                            â”‚
â”‚ âŒ Puede estar desactualizado                          â”‚
â”‚ âŒ Requiere conexiÃ³n previa                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” DecisiÃ³n de Fallback

```
            Intenta Endpoint 1
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
    âœ… OK?                  âŒ Falla
        â”‚                      â”‚
    Usa datos          Intenta Endpoint 2
        â”‚                      â”‚
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚                      â”‚
        â”‚      âœ… OK?                  âŒ Falla
        â”‚          â”‚                      â”‚
        â”‚      Usa datos          Â¿CachÃ© disponible?
        â”‚          â”‚                      â”‚
        â”‚          â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚          â”‚                      â”‚
        â”‚          â”‚      âœ… SÃ                  âŒ NO
        â”‚          â”‚          â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚          â”‚
                   â–¼          â–¼
            âœ… Login OK    âŒ Login Fail
            (Online o     (Error crÃ­tico)
             Offline)
```

---

## ğŸ’¾ Estado de CachÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CACHE STATE MACHINE              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  FIRST TIME (Sin CachÃ©)                   â”‚
â”‚  â”œâ”€ Con Internet: Descarga â†’ Cachea â†’ OK  â”‚
â”‚  â””â”€ Sin Internet: ERROR                   â”‚
â”‚                                            â”‚
â”‚  CACHED (Con CachÃ©)                       â”‚
â”‚  â”œâ”€ Con Internet: Intenta actualizar      â”‚
â”‚  â”‚  â”œâ”€ âœ… OK â†’ Usa nuevos datos           â”‚
â”‚  â”‚  â””â”€ âŒ Falla â†’ Usa cachÃ© viejo        â”‚
â”‚  â””â”€ Sin Internet: Usa cachÃ© automÃ¡tico    â”‚
â”‚                                            â”‚
â”‚  CACHE EXPIRY                             â”‚
â”‚  â”œâ”€ Edad mÃ¡xima: Depende configuraciÃ³n    â”‚
â”‚  â””â”€ Actualiza cuando: Cada login          â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Flujo de CORS EspecÃ­ficamente

```
                    Navegador hace request
                            â”‚
                            â–¼
                    Google (servidor)
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                        â”‚
            Permite CORS           Rechaza CORS
            (raramente)            (99% de veces)
                â”‚                        â”‚
                â–¼                        â–¼
            âœ… Response OK         âŒ CORS Error
            Datos llegan          "No Access-Control
            al navegador          Allow-Origin"
                                        â”‚
                                        â–¼
                                  Navegador lo
                                  bloquea (F12)
                                        â”‚
                                        â–¼
                                  Catch en try-catch
                                        â”‚
                                        â–¼
                                  Intenta Endpoint 2
                                  (o usa cachÃ©)
```

---

## ğŸ¯ Resumen Visual

| Paso | AcciÃ³n | Estado | Resultado |
|------|--------|--------|-----------|
| 1 | Intenta `/export` | ğŸ”„ Procesando | âœ… o âŒ |
| 2 | Si falla â†’ `/gviz` | ğŸ”„ Procesando | âœ… o âŒ |
| 3 | Si ambos fallan â†’ CachÃ© | ğŸ”„ Procesando | âœ… o âŒ |
| 4 | Si no hay cachÃ© â†’ ERROR | âŒ Error | âŒ Requiere Internet |

---

**VersiÃ³n**: 2.1  
**Fecha**: 6 de febrero de 2026  
**Estado**: âœ… Diagramas Completos
